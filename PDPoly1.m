clear
clc
close all

%% Lettura dati
TabAnno1 = readtable('.\caricoITAhour.xlsx', 'Range', 'A2:D8762');
TabAnno2 = readtable('.\caricoITAhour.xlsx', 'Range', 'A8763:D17522');

TabAnno2.Properties.VariableNames = {'giorno_anno','ora_giorno', ...
                                     'giorno_settimana','dati'};
                                        
%% Visualizzazione TUTTI i dati dei due anni                                 
% figure(1)
% scatter3(TabAnno1.giorno_anno, TabAnno1.ora_giorno, TabAnno1.dati, 'xgreen')
% hold on
% scatter3(TabAnno2.giorno_anno, TabAnno2.ora_giorno, TabAnno2.dati, 'xred')
% grid on
% xlabel("giorno")
% ylabel("ora")
% zlabel("dati GW")
% legend("Anno1", "Anno2")
% title("Panoramica generale per anno")

%% Selezione delle domeniche per anno e totali
% Le variabili 'giorno dell'anno' e 'ora del giorno' sono 
% normalizzate, dividendole rispettivamente per 365 e 24. 
Anno1 = [TabAnno1.giorno_anno, TabAnno1.ora_giorno, TabAnno1.dati];                                 
Anno2 = [TabAnno2.giorno_anno, TabAnno2.ora_giorno, TabAnno2.dati];

domeniche_anno1 = Anno1( (TabAnno1.giorno_settimana == 1 ), :, : );
domeniche_anno2 = Anno2( (TabAnno2.giorno_settimana == 1 ), :, : );

domeniche_totali = [domeniche_anno1];
domeniche_validazione = [domeniche_anno2];

domtot_giorno_anno = domeniche_totali(:,1) ./ 365 ;
domtot_ora_giorno = domeniche_totali(:,2) ./ 24 ;
domtot_dati = domeniche_totali(:,3) ;

domtot_giorno_anno_val = domeniche_validazione(:,1) ./ 365 ;
domtot_ora_giorno_val = domeniche_validazione(:,2) ./ 24 ;
domtot_dati_val = domeniche_validazione(:,3) ;

v1 = ones( length(domeniche_totali(:,3)) , 1 );

%% Verifica di outliers - NESSUN OUTLIER TROVATO
% domenicheAnno1_nonOutlier = isoutlier(domeniche_anno1(:,3), 'quartiles');
% domenicheAnno2_nonOutlier = isoutlier(domeniche_anno2(:,3), 'quartiles');
% 
% figure(1)
% subplot(2,1,1)
% boxplot(domeniche_anno1(:,3))
% subplot(2,1,2)
% boxplot(domeniche_anno2(:,3))
% 
% sum(domenicheAnno1_nonOutlier)
% sum(domenicheAnno2_nonOutlier)

%% Scatter-Plot delle domeniche per anno
figure(1)
scatter3(domeniche_anno1(:,1),domeniche_anno1(:,2),domeniche_anno1(:,3), 'xgreen')
hold on
scatter3(domeniche_anno2(:,1),domeniche_anno2(:,2),domeniche_anno2(:,3), 'xblue')
grid on
xlabel("giorno")
ylabel("ora")
zlabel("dati GW")
legend("Anno1", "Anno2")
title("Panoramica generale DOMENICHE per anno")

%% Analisi outliers domeniche totali - NESSUN OUTLIER TROVATO
% dom_tot_outliers = isoutlier( domeniche_totali(:,3), 'quartiles' );
% sum(dom_tot_outliers)

%% Verifica outliers giornaliero per OGNI domenica 
% NESSUN OUTLIER RILEVATO IN NESSUNA DOMENICA 

j = 0;
for i = 1 : 52
    domenica = domeniche_totali( j+1 : j+24 , 1:3);
    domenica_outliers = isoutlier(domenica(:,3), 'quartiles');
    outliers_tot(i) = sum(domenica_outliers);
    j = j + 24;
end

Somma_totale_outliers = sum(outliers_tot)     % = 0 

%% Modello polinomiale di TERZO grado 
phi_mod3 = [ v1, domtot_giorno_anno, domtot_ora_giorno, ...
            (domtot_giorno_anno.^2), (domtot_ora_giorno.^2), ...
            (domtot_giorno_anno .* domtot_ora_giorno), ...
            (domtot_giorno_anno.^3), (domtot_ora_giorno.^3), ...
            ( (domtot_giorno_anno.^2) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^2) .* domtot_giorno_anno ) ] ;

%Stima LS e calcolo della predizione        
LS_mod3 = lscov (phi_mod3 , domtot_dati);
mod3 = phi_mod3 * LS_mod3 ;

figure(3)
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, domtot_dati, 'xgreen')
hold on
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, mod3, 'xblue')
grid on 

xlabel("Giorno Anno")
ylabel("Ora del giorno")
zlabel("Dati")
title("Stima - Modello TERZO grado")
legend("dati", "predizione")

%% Modello polinomiale di QUARTO grado
phi_mod4 = [ v1, domtot_giorno_anno, domtot_ora_giorno, ...
            (domtot_giorno_anno.^2), (domtot_ora_giorno.^2), ...
            (domtot_giorno_anno .* domtot_ora_giorno), ...
            (domtot_giorno_anno.^3), (domtot_ora_giorno.^3), ...
            ( (domtot_giorno_anno.^2) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^2) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^4), (domtot_ora_giorno .^4), ...
            ( (domtot_giorno_anno .^2).*(domtot_ora_giorno .^2) ),...
            ( (domtot_giorno_anno.^3) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^3) .* domtot_giorno_anno ) ] ;

%Stima LS e calcolo della predizione        
LS_mod4 = lscov (phi_mod4 , domtot_dati);
mod4 = phi_mod4 * LS_mod4 ;

figure(4)
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, domtot_dati, 'xgreen')
hold on
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, mod4, 'xblue')
grid on 

xlabel("Giorno Anno")
ylabel("Ora del giorno")
zlabel("Dati")
title("Stima - Modello QUARTO grado")
legend("dati", "predizione")

%% Modello polinomiale di QUINTO grado
phi_mod5 = [ v1, domtot_giorno_anno, domtot_ora_giorno, ...
            (domtot_giorno_anno.^2), (domtot_ora_giorno.^2), ...
            (domtot_giorno_anno .* domtot_ora_giorno), ...
            (domtot_giorno_anno.^3), (domtot_ora_giorno.^3), ...
            ( (domtot_giorno_anno.^2) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^2) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^4), (domtot_ora_giorno .^4), ...
            ( (domtot_giorno_anno .^2).*(domtot_ora_giorno .^2) ),...
            ( (domtot_giorno_anno.^3) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^3) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^5), (domtot_ora_giorno .^5), ...
            ( (domtot_giorno_anno .^3).*(domtot_ora_giorno .^2) ),...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno ) ),...
            ( (domtot_ora_giorno .^3) .*(domtot_giorno_anno .^2) ),... 
            ( (domtot_ora_giorno .^4) .* domtot_giorno_anno)] ;

%Stima LS e calcolo della predizione
LS_mod5 = lscov (phi_mod5 , domtot_dati);
mod5 = phi_mod5 * LS_mod5 ;

figure(5)
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, domtot_dati, 'xgreen')
hold on
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, mod5, 'xblue')
grid on 

xlabel("Giorno Anno")
ylabel("Ora del giorno")
zlabel("Dati")
title("Stima - Modello 	Quinto grado")
legend("dati", "predizione")

%% Modello polinomiale di SESTO grado
phi_mod6 = [ v1, domtot_giorno_anno, domtot_ora_giorno, ...
            (domtot_giorno_anno.^2), (domtot_ora_giorno.^2), ...
            (domtot_giorno_anno .* domtot_ora_giorno), ...
            (domtot_giorno_anno.^3), (domtot_ora_giorno.^3), ...
            ( (domtot_giorno_anno.^2) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^2) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^4), (domtot_ora_giorno .^4), ...
            ( (domtot_giorno_anno .^2).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno.^3) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^3) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^5), (domtot_ora_giorno .^5), ...
            ( (domtot_giorno_anno .^3).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno ) ), ...
            ( (domtot_ora_giorno .^3) .*(domtot_giorno_anno .^2) ), ... 
            ( (domtot_ora_giorno .^4) .* domtot_giorno_anno ) , ...
            (domtot_giorno_anno .^6), (domtot_ora_giorno .^6), ...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno .^5).*(domtot_ora_giorno ) ), ...
            ( (domtot_giorno_anno .^3).*(domtot_ora_giorno .^3) ), ...
            ( (domtot_ora_giorno .^4) .*(domtot_giorno_anno .^2) ), ... 
            ( (domtot_ora_giorno .^5) .* domtot_giorno_anno)] ;

%Stima LS e calcolo della predizione
LS_mod6 = lscov (phi_mod6 , domtot_dati);
mod6 = phi_mod6 * LS_mod6 ;

figure(6)
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, domtot_dati, 'xgreen')
hold on
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, mod6, 'xblue')
grid on 

xlabel("Giorno Anno")
ylabel("Ora del giorno")
zlabel("Dati")
title("Stima - Modello SESTO grado")
legend("dati", "predizione")

%% Modello polinomiale di SETTIMO grado
phi_mod7 = [ v1, domtot_giorno_anno, domtot_ora_giorno, ...
            (domtot_giorno_anno.^2), (domtot_ora_giorno.^2), ...
            (domtot_giorno_anno .* domtot_ora_giorno), ...
            (domtot_giorno_anno.^3), (domtot_ora_giorno.^3), ...
            ( (domtot_giorno_anno.^2) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^2) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^4), (domtot_ora_giorno .^4), ...
            ( (domtot_giorno_anno .^2).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno.^3) .* domtot_ora_giorno ), ...
            ( (domtot_ora_giorno .^3) .* domtot_giorno_anno ), ...
            (domtot_giorno_anno .^5), (domtot_ora_giorno .^5), ...
            ( (domtot_giorno_anno .^3).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno ) ), ...
            ( (domtot_ora_giorno .^3) .*(domtot_giorno_anno .^2) ), ... 
            ( (domtot_ora_giorno .^4) .* domtot_giorno_anno ) , ...
            (domtot_giorno_anno .^6), (domtot_ora_giorno .^6), ...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno .^5).*(domtot_ora_giorno ) ), ...
            ( (domtot_giorno_anno .^3).*(domtot_ora_giorno .^3) ), ...
            ( (domtot_ora_giorno .^4) .*(domtot_giorno_anno .^2) ), ... 
            ( (domtot_ora_giorno .^5) .* domtot_giorno_anno), ...
            (domtot_giorno_anno .^7), (domtot_ora_giorno .^7), ...
            ( (domtot_giorno_anno .^6).*(domtot_ora_giorno .^1) ), ...
            ( (domtot_giorno_anno .^5).*(domtot_ora_giorno .^2) ), ...
            ( (domtot_giorno_anno .^4).*(domtot_ora_giorno .^3) ), ...
            ( (domtot_ora_giorno .^4) .*(domtot_giorno_anno .^3) ), ... 
            ( (domtot_ora_giorno .^5) .* (domtot_giorno_anno .^2) ), ...
            ( (domtot_ora_giorno .^6).*(domtot_giorno_anno .^1) ) ] ;

%Stima LS e calcolo della predizione
LS_mod7 = lscov (phi_mod7 , domtot_dati);
mod7 = phi_mod7 * LS_mod7 ;

figure(7)
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, domtot_dati, 'xgreen')
hold on
scatter3(domtot_giorno_anno.*365, domtot_ora_giorno.*24, mod7, 'xblue')
grid on 

xlabel("Giorno Anno")
ylabel("Ora del giorno")
zlabel("Dati")
title("Stima - Modello SETTIMO grado")
legend("dati", "predizione")

%% CROSS-VALIDAZIONE CON DATI SECONDO ANNO
phi_mod3_val = [ v1, domtot_giorno_anno_val, domtot_ora_giorno_val, ...
            (domtot_giorno_anno_val.^2), (domtot_ora_giorno_val.^2), ...
            (domtot_giorno_anno_val .* domtot_ora_giorno_val), ...
            (domtot_giorno_anno_val.^3), (domtot_ora_giorno_val.^3), ...
            ( (domtot_giorno_anno_val.^2) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^2) .* domtot_giorno_anno_val ) ] ;

phi_mod4_val = [ v1, domtot_giorno_anno_val, domtot_ora_giorno_val, ...
            (domtot_giorno_anno_val.^2), (domtot_ora_giorno_val.^2), ...
            (domtot_giorno_anno_val .* domtot_ora_giorno_val), ...
            (domtot_giorno_anno_val.^3), (domtot_ora_giorno_val.^3), ...
            ( (domtot_giorno_anno_val.^2) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^2) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^4), (domtot_ora_giorno_val .^4), ...
            ( (domtot_giorno_anno_val .^2).*(domtot_ora_giorno_val .^2) ),...
            ( (domtot_giorno_anno_val.^3) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^3) .* domtot_giorno_anno_val ) ] ;

phi_mod5_val = [ v1, domtot_giorno_anno_val, domtot_ora_giorno_val, ...
            (domtot_giorno_anno_val.^2), (domtot_ora_giorno_val.^2), ...
            (domtot_giorno_anno_val .* domtot_ora_giorno_val), ...
            (domtot_giorno_anno_val.^3), (domtot_ora_giorno_val.^3), ...
            ( (domtot_giorno_anno_val.^2) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^2) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^4), (domtot_ora_giorno_val .^4), ...
            ( (domtot_giorno_anno_val .^2).*(domtot_ora_giorno_val .^2) ),...
            ( (domtot_giorno_anno_val.^3) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^3) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^5), (domtot_ora_giorno_val .^5), ...
            ( (domtot_giorno_anno_val .^3).*(domtot_ora_giorno_val .^2) ),...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val ) ),...
            ( (domtot_ora_giorno_val .^3) .*(domtot_giorno_anno_val .^2) ),... 
            ( (domtot_ora_giorno_val .^4) .* domtot_giorno_anno_val)] ;

phi_mod6_val = [ v1, domtot_giorno_anno_val, domtot_ora_giorno_val, ...
            (domtot_giorno_anno_val.^2), (domtot_ora_giorno_val.^2), ...
            (domtot_giorno_anno_val .* domtot_ora_giorno_val), ...
            (domtot_giorno_anno_val.^3), (domtot_ora_giorno_val.^3), ...
            ( (domtot_giorno_anno_val.^2) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^2) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^4), (domtot_ora_giorno_val .^4), ...
            ( (domtot_giorno_anno_val .^2).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val.^3) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^3) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^5), (domtot_ora_giorno_val .^5), ...
            ( (domtot_giorno_anno_val .^3).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val ) ), ...
            ( (domtot_ora_giorno_val .^3) .*(domtot_giorno_anno_val .^2) ), ... 
            ( (domtot_ora_giorno_val .^4) .* domtot_giorno_anno_val ) , ...
            (domtot_giorno_anno_val .^6), (domtot_ora_giorno_val .^6), ...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val .^5).*(domtot_ora_giorno_val ) ), ...
            ( (domtot_giorno_anno_val .^3).*(domtot_ora_giorno_val .^3) ), ...
            ( (domtot_ora_giorno_val .^4) .*(domtot_giorno_anno_val .^2) ), ... 
            ( (domtot_ora_giorno_val .^5) .* domtot_giorno_anno_val)] ;
        
phi_mod7_val = [ v1, domtot_giorno_anno_val, domtot_ora_giorno_val, ...
            (domtot_giorno_anno_val.^2), (domtot_ora_giorno_val.^2), ...
            (domtot_giorno_anno_val .* domtot_ora_giorno_val), ...
            (domtot_giorno_anno_val.^3), (domtot_ora_giorno_val.^3), ...
            ( (domtot_giorno_anno_val.^2) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^2) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^4), (domtot_ora_giorno_val .^4), ...
            ( (domtot_giorno_anno_val .^2).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val.^3) .* domtot_ora_giorno_val ), ...
            ( (domtot_ora_giorno_val .^3) .* domtot_giorno_anno_val ), ...
            (domtot_giorno_anno_val .^5), (domtot_ora_giorno_val .^5), ...
            ( (domtot_giorno_anno_val .^3).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val ) ), ...
            ( (domtot_ora_giorno_val .^3) .*(domtot_giorno_anno_val .^2) ), ... 
            ( (domtot_ora_giorno_val .^4) .* domtot_giorno_anno_val ) , ...
            (domtot_giorno_anno_val .^6), (domtot_ora_giorno_val .^6), ...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val .^2) ), ...
            ( (domtot_giorno_anno_val .^5).*(domtot_ora_giorno_val ) ), ...
            ( (domtot_giorno_anno_val .^3).*(domtot_ora_giorno_val .^3) ), ...
            ( (domtot_ora_giorno_val .^4) .*(domtot_giorno_anno_val .^2) ), ... 
            ( (domtot_ora_giorno_val .^5) .* domtot_giorno_anno_val), ...
            (domtot_giorno_anno_val .^7), (domtot_ora_giorno_val .^7), ...
            ( (domtot_giorno_anno_val .^6).*(domtot_ora_giorno_val .^1) ), ...
            ( (domtot_giorno_anno_val .^5).*(domtot_ora_giorno_val.^2) ), ...
            ( (domtot_giorno_anno_val .^4).*(domtot_ora_giorno_val .^3) ), ...
            ( (domtot_ora_giorno_val .^4) .*(domtot_giorno_anno_val .^3) ), ... 
            ( (domtot_ora_giorno_val .^5) .* (domtot_giorno_anno_val .^2) ), ...
            ( (domtot_ora_giorno_val .^6).*(domtot_giorno_anno_val .^1) ) ] ;        
        
residuo3_val = (domtot_dati_val - phi_mod3_val * LS_mod3);
residuo4_val = (domtot_dati_val - phi_mod4_val * LS_mod4);
residuo5_val = (domtot_dati_val - phi_mod5_val * LS_mod5);
residuo6_val = (domtot_dati_val - phi_mod6_val * LS_mod6);
residuo7_val = (domtot_dati_val - phi_mod7_val * LS_mod7);

SSR3_VAL = (residuo3_val)' * (residuo3_val);
SSR4_VAL = (residuo4_val)' * (residuo4_val);
SSR5_VAL = (residuo5_val)' * (residuo5_val);
SSR6_VAL = (residuo6_val)' * (residuo6_val);
SSR7_VAL = (residuo7_val)' * (residuo7_val);

SSR_VAL = [SSR3_VAL ; SSR4_VAL; SSR5_VAL; SSR6_VAL; SSR7_VAL];

SSR_VALIDAZIONE = SSR_VAL(:)
SSR_MINIMO = min(SSR_VAL)

x = 3 : 1 : 7 ;

figure()
scatter(x, SSR_VAL(:), 'xred')
grid on
title("Andamento SSR di validazione")
